---
#CSS_ALL:
editor_options: 
  chunk_output_type: console
---

#CHUNK_OPT:

#CT_TITLE:

#CT_ALL1:

#CT_SEURAT1:

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(venn)
  library(dplyr)
  library(cowplot)
  library(ggplot2)
  library(pheatmap)
  library(rafalib)
  library(scPred)
})
```

```{r}
#load the data and select 'ctrl_13` sample
alldata <- readRDS("data/results/covid_qc_dr_int_cl.rds")
ctrl = alldata[, alldata$orig.ident == 'ctrl_13']

# set active assay to RNA and remove the CCA assay
ctrl@active.assay = 'RNA' 
ctrl[['CCA']] = NULL
ctrl
```



```{r}
reference <- scPred::pbmc_1

reference
```

#CT_SEURAT3:

```{r}
reference <- reference %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA(verbose = F) %>%
  RunUMAP(dims = 1:30)
```

```{r, fig.width=5}
DimPlot(reference, group.by = "cell_type", label = TRUE, repel = TRUE) + NoAxes()
```


#CT_ALL4:

```{r}
#Set the identity as louvain with resolution 0.3
ctrl <- SetIdent(ctrl, value = "CCA_snn_res.0.3")
  
ctrl <- ctrl %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA(verbose = F) %>%
  RunUMAP(dims = 1:30)

```

```{r, fig.width=5}
DimPlot(ctrl,  label = TRUE, repel = TRUE) + NoAxes()
```


#CT_SEURAT4:

```{r}
transfer.anchors <- FindTransferAnchors(reference = reference, query = ctrl, 
    dims = 1:30)
predictions <- TransferData(anchorset = transfer.anchors, refdata = reference$cell_type, 
    dims = 1:30)
ctrl <- AddMetaData(object = ctrl, metadata = predictions)
```

```{r}

DimPlot(ctrl, group.by = "predicted.id", label = T, repel = T) + NoAxes()
```

#CT_SEURAT4.2:

```{r}
ggplot(ctrl@meta.data, aes(x=CCA_snn_res.0.3, fill = predicted.id)) + geom_bar() + theme_classic()
```

#CT_SEURAT5:

```{r}
reference <- getFeatureSpace(reference, "cell_type")

reference <- trainModel(reference)
```

#CT_SEURAT5.2:

```{r}
get_scpred(reference)
```

#CT_SEURAT5.3:

```{r}
ctrl <- scPredict(ctrl, reference)
```

```{r}
DimPlot(ctrl, group.by = "scpred_prediction", label = T, repel = T) + NoAxes()
```

#CT_SEURAT5.4:

```{r}
ggplot(ctrl@meta.data, aes(x=CCA_snn_res.0.3, fill = scpred_prediction)) + geom_bar() + theme_classic()
```

#CT_ALL6:

#CT_SEURAT6:

```{r}
crossTab(ctrl, "predicted.id", "scpred_prediction")
```

#CT_ALL7:

```{r}
saveRDS(ctrl,"data/results/ctrl13_qc_dr_int_cl_celltype.rds")
```


#SESSION_INFO:

```{r}
sessionInfo()
```








```{r}
# Download gene marker list
if(!dir.exists("data/CellMarker_list/")) {
  dir.create("data/CellMarker_list")
  download.file(url="http://bio-bigdata.hrbmu.edu.cn/CellMarker/download/Human_cell_markers.txt",
                destfile = "./data/CellMarker_list/Human_cell_markers.txt")
  download.file(url="http://bio-bigdata.hrbmu.edu.cn/CellMarker/download/Mouse_cell_markers.txt",
                destfile = "./data/CellMarker_list/Mouse_cell_markers.txt")
  download.file(url="https://www.gsea-msigdb.org/gsea/msigdb/download_file.jsp?filePath=/msigdb/release/7.2/c8.all.v7.2.symbols.gmt","./data/MSigDB_files/c8.all.v7.2.symbols.gmt.txt")
}
```



```{r}
celltype_list <- gmtPathways("~/Downloads/c8.all.v7.2.symbols.gmt")
length(celltype_list)

# Load the table
markers <- read.delim("data/CellMarker_list/Human_cell_markers.txt")
colnames(markers)
markers <- markers [ markers$speciesType == "Human", ]
markers <- markers [ markers$cancerType == "Normal", ]

#Filter by tissue (to reduce computational time and have tissue-specific classification)
# sort(unique(markers$tissueType))
# grep("blood",unique(markers$tissueType),value = T)
# markers <- markers [ markers$tissueType %in% c("Blood","Venous blood",
#                                                "Serum","Plasma",
#                                                "Spleen","Bone marrow","Lymph node"), ]
# markers <- markers [ markers$tissueType %in% c("Blood"), ]

celltype_list <- lapply( unique(markers$cellName) , function(x){
  x <- paste(markers$geneSymbol[markers$cellName == x],sep=",")
  x <- gsub("[[]|[]]| |-",",",x)
  x <- unlist(strsplit( x , split = ","))
  x <- unique(x [ ! x %in% c("","NA","family") ])
  x <- casefold(x,upper = T)
})
names(celltype_list) <- unique(markers$cellName)
# celltype_list <- lapply(celltype_list , function(x) {x[1:min(length(x),50)]} )
celltype_list <- celltype_list[ unlist(lapply(celltype_list,length)) < 100 ]
celltype_list <- celltype_list[ unlist(lapply(celltype_list,length)) > 5 ]



# Compute differential gene expression in reference dataset (that has cell annotation)
reference <- SetIdent( reference, value = "cell_type")
reference_markers <- FindAllMarkers( reference , min.pct = .1 , 
                                     min.diff.pct = .2, only.pos = T, 
                                     max.cells.per.ident = 20 ,
                                     return.thresh = 1 )

# Identify the top cell marker genes in reference dataset
reference_markers <- reference_markers [ order(reference_markers$avg_logFC,decreasing = T), ]
reference_markers %>% 
  group_by(cluster) %>% 
  top_n(-100, p_val) %>% 
  top_n(50, avg_logFC) -> top10_cell_selection

# Transform the markers into a list
celltype_list <- lapply( unique(top10_cell_selection$cluster) , function(x){
  x <- top10_cell_selection$gene [top10_cell_selection$cluster == x]
} )
names(celltype_list) <- unique(top10_cell_selection$cluster)
celltype_list

```


```{r}
alldata <- SetIdent(alldata,value = "CCA_snn_res.0.3")
DGE_list <- FindAllMarkers(alldata,
                               logfc.threshold = 0,
                               test.use = "wilcox",
                               min.pct = 0,
                               min.diff.pct = 0,
                               only.pos = TRUE,
                               max.cells.per.ident = 20,
                               return.thresh = 1,
                               assay = "RNA")


res <- lapply(as.character(unique(DGE_list$cluster)),function(x){
  gene_rank <- setNames(DGE_list$avg_logFC [ DGE_list$cluster == x],
                        DGE_list$gene [ DGE_list$cluster == x])
  fgseaRes <- fgsea( pathways=celltype_list, stats=gene_rank)
  return(fgseaRes)
})
names(res) <- as.character(unique(DGE_list$cluster))
res

# You can resort the table based on ES, NES or pvalue
res <- lapply(res, function(x) {x[ x$pval < 0.1 , ]} )
res <- lapply(res, function(x) {x[ x$size > 2 , ]} )
res <- lapply(res, function(x) {x[order(x$NES,decreasing = T), ]} )
res

new.cluster.ids <- unlist(lapply(res,function(x){as.data.frame(x)[1,1]}))
alldata <- RenameIdents(alldata, new.cluster.ids)
alldata$predicted <- alldata@active.ident

DimPlot(alldata,label = T,group.by = "CCA_snn_res.0.3")
DimPlot(alldata,label = T)
```




